## EdgeRec: Recommender System on Edge in Mobile Taobao

论文地址：https://arxiv.org/abs/2005.08416

作者：Yu Gong, Ziwen Jiang, Yufei Feng, Binbin Hu, Kaiqi Zhao, Qingwen Liu, Wenwu Ou

机构：阿里巴巴

发表：Accepted by CIKM 2020;

https://github.com/tao-shen/EdgeRec



### 摘要

Our work, to our best knowledge, is the first attempt to design and implement the novel Recommender System on Edge (EdgeRec), which achieves Real-time User Perception and Real-time System Feedback. 

Moreover, we propose ==Heterogeneous User Behavior Sequence Modeling== and ==Context-aware Reranking with Behavior Attention Networks== to capture user's diverse interests and adjust recommendation results accordingly. 

Experimental results on both the offline evaluation and online performance in Taobao home-page feeds demonstrate the effectiveness of EdgeRec.



### 系统架构

<img src="D:\Notes\raw_images\image-20220325154504832.png" alt="image-20220325154504832" style="zoom:80%;" />

- Client Native（CN）：首先发起分页请求，从RS服务器返回候选Item的==特征和Embedding==进行缓存。在 EdgeRec 中，分页大小设置为 50，为了稳定性与淘宝中的原始 RS 相同。同时，RS服务器返回的item数量设置为100，以便在设备上提供更多的reranking空间。然后，CN收集用户对暴露item的行为并触发模型服务模块。在从模型服务模块接收到候选（a.k.a. unexposed）项目的排序后，CN 调整 Item的 UI 显示。
- Model Serving（MS)：当由CN触发时，MS对从CN处接收到的用户行为和候选商品进行特征工程，然后基于神经网络的模型，其目的是通过用户行为建模来及时捕捉用户行为，并对上下文感知的Reranking以及时响应用户，MS向云发送日志，并将候选商品的排名结果返回给CN;
- Recommender System(RS): 响应来自CN的页面请求，并为候选项提供初始排序。此外，它还可以在响应CN之前从云上的key-value存储中查找MS模块中的模型需要的商品特征和Embedding;
- Offline Training(OT): 在模型训练之前，模块首先从MS中收集日志并构造样本。然后，将训练后的模型分为三个部分:(1).用户行为建模子模型;(2).上下文感知重排子模型;(3).嵌入矩阵(如类别和品牌)。最后，将前两个子模型部署在MS模块上，嵌入矩阵作为key-value形式保存在云上。

### **端智能基础设施建设**

高楼起于平地，打造端智能这幢摩天大楼需要很多基础设施，剥除各种各样边角料和锦上添花的东西后，我们认为构成支撑起端智能体系的骨架组成部分主要有数据、端计算、端计算引擎、端智能决策框架、算法研发平台。其中，端侧数据 、端计算、端计算引擎这三块的作用是实时感知用户，计算出贴合用户的结果；端智能决策框架是触达用户的通道，通过端上实时智能决策衔接用户意图和端计算，最后通过一定的干预手段展现到用户眼前；算法研发平台是开发过程主要接触的平台，能有效提升研发效率。通过一个简单的示意图也许能更好的理解这五大块：

<img src="https://image.jiqizhixin.com/uploads/editor/988a959e-fc8d-4b0e-b0a2-23151864fc2d/640.png" alt="img" style="zoom: 50%;" />

**数据-BehaviX**

无论计算是发生在云端还是终端，数据始终是执行所有计算的基本要素之一，端计算的本质也是计算，数据当然也是他的要素之一。在淘宝或者其他阿里系App里我们已经有很多数据沉淀，这些数据包括但不限于商品、商品特征、用户特征等。这些数据同样可以作为端计算的输入来源，但如果只有这些，端计算和云计算相比在数据上似乎没有什么明显优势了，所以我们需要回过头看下端计算作为端智能的重要部分，他的在数据上的核心优势是什么？端计算运行在端上，天然能获取端上的数据，而且是实时获取。我们希望这部分数据是和已有数据是互补的、对端计算是有价值的，端计算的目的之一是千人千面，端上丰富的用户特征，能体现当前用户的实时意图。所以我们在构建了==端侧用户特征数据中心BehaviX==。

BehaviX作为整个端智能的数据基础，提供给算法特征数据作为模型数据输入源，==支持了特征实时同步云端，让云端能够秒级感知到端侧用户特征，提供了算法基于端侧用户特征数据做意图分析的能力==。

**端智能决策框架-BehaviR**

从用户角度来看，用户感知到的不是一堆数据和计算而是能够被感知到的结果，因此，即使计算出来的结果无比贴合用户意图，如果无法及时触达用户也是无用功。触达用户方式多种多样，我们需要基于实际场景放开手大胆探索，合理的产品设计会让用户觉得是在和一个“智能”的App交流，反之，不合理的产品设计会打扰用户、对用户造成困扰。从技术角度来说，我们要设计和做的其实是一条触达通道，通过感知用户触点，我们能根据运营规则配置或者本地模型决策出此时要给用户什么类型的反馈，然后通过下面要讲述的端计算能力计算出贴合用户的结果并展示给用户，以此将端计算和用户连接在一起。

端智能决策框架能简化业务方接入端智能流程，帮助业务方真正做到实时感知、及时干预，更多详细内容。

**端计算-EdgeRec**

端计算简单理解起来可以认为是跑在端上的一段逻辑，这段逻辑可以是一个预置的Native任务，也可以是一个脚本，当然，在最终我们希望他是一个算法模型。算法模型是目前做到千人千面的有效手段之一，其他优势不再累述了，详见下面的友情链接。   

回到这里的主角EdgeRec-边缘计算算法，他在在端上实时建模了用户的异构特征序列，为端上决策提供通用的用户状态表达。通过多任务学习，共享通用的用户状态表达，在端上建模多种决策模型。另外，边缘计算算法SDK也提供端上深度学习算法开发的通用解决方案，如：端上深度学习模型库、端上模型拆分部署、端上模型版本控制、端上样本生成等。

**端计算引擎-Walle&MNN**

端计算引擎是端智能体系中重要的一环，是算法模型的基础环境。无论是iOS还是Android目前都提供了一套环境，但两端差异性比较大，限制也比较多。构建一套端计算引擎的成本是非常高的，但长远来看统一两端引擎、抹平差异是有非常有必要的。Walle和MNN作为当前我们端计算引擎很好地做到了这一点。 

Walle是端上整体的Runtime，他为算法的Python脚本、深度模型以及Jarvis的EFC、ESC等特征样本计算库提供运行环境，另外也为BehaviX管理的基础数据提供存储服务。  

MNN 是一个轻量级的深度学习端侧推理引擎，核心解决深度神经网络模型在端侧推理运行问题，涵盖深度神经网络模型的优化、转换和推理，其前身为 AliNN。

**算法研发平台-Jarvis**

算法模型的研发并不是简单地在本地IDE写一份代码那么简单，我们通常需要理论调研、算法开发、模型训练、参数调优、线上验证等等步骤，本地环境是远远不够的，所以算法研发平台的存在能帮助算法同学更高效、更专注地进行研发工作。另外，端智能要出结果，一定是多团队通力合作的结果，多团队合作仅靠口头沟通是远远不够的，我们需要一套合理的流程去简化和规范各项工作，因此，在算法研发平台的基础之上我们仍旧需要一个一站式平台。

Jarvis提供一站式的开发、调试、验证、AB测试、发布、监控平台，与算法同学共建一起打造了端上的特征计算、样本计算等基础库。

**整体流程图**

我们构建了端智能的五个基础设施，通过端上调度系统，将整个端智能技术体系串联起来，总体来说分为用户触达和用户感知部分。用户触达部分包括端上调度和端上决策，端上调度提供和业务的直接对接，端上决策由端上调度系统在合适的时候拉起本地算法计算；用户感知部分则对用户特征进行标准化端上用户特征，提供端侧计算的数据输入。

<img src="https://image.jiqizhixin.com/uploads/editor/3e44b6b4-6135-49b0-b3d5-4d54f14268dd/640.png" alt="img" style="zoom:50%;" />

### **数据效果**

从年初信息流端智能立项以来，我们经过最开始的小流量实验，效果逐渐优化，大半年的不断探索试错，信息流端智能于9月中旬在首页猜你喜欢场景全量。双十一当天也取得了不错的业务效果，对商品推荐的准确度提升，信息流GMV和点击量都大幅提升。其实这只是信息流在端智能的开始，相信后面更深入的优化探索，我们将会取到更好的效果。

### **总结**

从我们以往的经验来看，端侧做的更多的是将云端内容以具体的形式呈现给用户。当端侧也具备了感知用户意图并智能做出决策时，端侧的能力就不再局限于“呈现”，端侧也可以”思考“。业务可以利用端侧”思考“能力，将以往在云端解决起来比较困难的问题放到端上去解决，如云端决策实时性问题、大数据量上报云端分析的资源消耗问题；可以结合端侧本身的特性，如传感器、相机、UI呈现等，去思考如何去整合用户特征、数据、端侧算法去大胆尝试找到新的突破口。